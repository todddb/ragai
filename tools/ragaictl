#!/usr/bin/env bash
set -euo pipefail

command=${1:-}
shift || true

# Default services to run for "start"/"restart"/setup-new.
# NOTE: We intentionally include ingestor-worker (queue consumer) but NOT ingestor (one-shot).
default_services() {
  echo "ollama qdrant redis api frontend ingestor-worker"
}

usage() {
  cat <<'EOF'
Usage: ragaictl <command> [options]

Commands:
  setup-new                             First-time setup (dirs, deps, build, start, pull models)
  start [service...]                    Start services (default: ollama qdrant redis api frontend ingestor-worker), then health check
  stop [service...]                     Stop services (default: all) WITHOUT removing containers
  down                                  Remove containers/networks created by compose (docker compose down)
  status                                Show service status
  logs [service] [--tail N]             Follow logs (optionally scoped to a service)
  build [--no-cache] [service...]       Build images (default: all services)
  restart [service...]                  Restart services (default: all), then health check
  export [scope] [--max-lines N]        Export project snapshot (replaces dump_project)

  change-owner [path...]                Fix ownership on bind-mounted dirs (default: data config qdrant_storage ollama_models)
                                        Requires sudo; prompts only when you run this command.

Export scopes:
  all-code   (default, no data, no secrets)
  all        (includes data, excludes secrets)
  api
  docs       (/docs -if exists, *.md)
  ingestor
  frontend

Notes:
  - Secrets are always excluded from exports.
  - 'stop' keeps containers; 'down' removes them.
  - Ownership fixes are now manual via: ragaictl change-owner
  - Ingest is driven by the Redis queue worker: ingestor-worker (included in default start)
EOF
}

# Parse simple optional flag for logs
logs_cmd() {
  local service=""
  local tail_arg=""

  if [[ $# -gt 0 && "${1:-}" != --* ]]; then
    service="$1"
    shift
  fi

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --tail)
        tail_arg="--tail=${2:-200}"
        shift 2
        ;;
      *)
        echo "Unknown option for logs: $1"
        exit 1
        ;;
    esac
  done

  if [[ -n "$service" ]]; then
    docker compose logs -f $tail_arg "$service"
  else
    docker compose logs -f $tail_arg
  fi
}

check_health() {
  local max_attempts=30
  local attempt=1
  local api_health_url="http://localhost:8000/api/health"
  local worker_status_url="http://localhost:8000/api/ingest/worker/status"

  echo "‚è≥ Waiting for API to become available..."
  while [ $attempt -le $max_attempts ]; do
    if curl -s -f -m 2 "$api_health_url" > /dev/null 2>&1; then
      echo "‚úÖ API is responding"
      break
    fi
    sleep 1
    attempt=$((attempt + 1))
  done

  if [ $attempt -gt $max_attempts ]; then
    echo "‚ùå API failed to start after ${max_attempts}s"
    echo ""
    echo "Recent API logs:"
    docker compose logs api --tail=50
    return 1
  fi

  local health_json
  health_json=$(curl -s -f -m 2 "$api_health_url" 2>/dev/null || echo '{}')

  local api_status
  local ollama_status
  local qdrant_status
  local redis_status
  api_status=$(echo "$health_json" | grep -o '"api":"[^"]*"' | cut -d'"' -f4 || true)
  ollama_status=$(echo "$health_json" | grep -o '"ollama":"[^"]*"' | cut -d'"' -f4 || true)
  qdrant_status=$(echo "$health_json" | grep -o '"qdrant":"[^"]*"' | cut -d'"' -f4 || true)
  redis_status=$(echo "$health_json" | grep -o '"redis":"[^"]*"' | cut -d'"' -f4 || true)

  # Worker status is optional (don‚Äôt fail health check solely on this),
  # but it‚Äôs very helpful for usability.
  local worker_json=""
  local worker_ok="unknown"
  local worker_age="unknown"

  if worker_json=$(curl -s -m 2 "$worker_status_url" 2>/dev/null); then
    # expected shape: { ok: bool, age_seconds: number|null, ... }
    worker_ok=$(echo "$worker_json" | grep -o '"ok":[^,}]*' | head -n1 | cut -d: -f2 | tr -d ' ' || echo "unknown")
    worker_age=$(echo "$worker_json" | grep -o '"age_seconds":[^,}]*' | head -n1 | cut -d: -f2 | tr -d ' ' || echo "unknown")
  fi

  echo ""
  echo "=== Health Check Summary ==="
  [[ "$api_status" == "ok" ]] && echo "‚úÖ API OK" || echo "‚ùå API FAILED"
  [[ "$ollama_status" == "ok" ]] && echo "‚úÖ Ollama OK" || echo "‚ùå Ollama FAILED (status: ${ollama_status:-unknown})"
  [[ "$qdrant_status" == "ok" ]] && echo "‚úÖ Qdrant OK" || echo "‚ùå Qdrant FAILED (status: ${qdrant_status:-unknown})"
  if [[ -n "${redis_status:-}" ]]; then
    [[ "$redis_status" == "ok" ]] && echo "‚úÖ Redis OK" || echo "‚ùå Redis FAILED (status: ${redis_status:-unknown})"
  fi

  # If the endpoint exists, report it clearly
  if [[ "$worker_ok" != "unknown" ]]; then
    if [[ "$worker_ok" == "true" || "$worker_ok" == "ok" ]]; then
      echo "‚úÖ Ingest Worker OK (age_seconds: ${worker_age})"
    else
      echo "‚ö†Ô∏è  Ingest Worker NOT OK (ok: ${worker_ok}, age_seconds: ${worker_age})"
      echo "   Tip: ./tools/ragaictl logs ingestor-worker"
    fi
  else
    echo "‚ÑπÔ∏è  Ingest Worker status: unknown (endpoint not available yet)"
  fi

  echo "==========================="
  echo ""

  [[ "$api_status" == "ok" ]]
}

# Default ownership targets (bind-mounted dirs that commonly get root-owned files)
default_owner_targets() {
  echo "data config qdrant_storage ollama_models"
}

change_owner_cmd() {
  local targets=()
  if [[ $# -gt 0 ]]; then
    targets=("$@")
  else
    # shellcheck disable=SC2207
    targets=($(default_owner_targets))
  fi

  local existing=()
  for t in "${targets[@]}"; do
    [[ -e "$t" ]] && existing+=("$t")
  done

  if [[ ${#existing[@]} -eq 0 ]]; then
    echo "‚ÑπÔ∏è  No matching paths exist to chown."
    return 0
  fi

  echo "üßπ Fixing ownership on: ${existing[*]}"
  if command -v sudo >/dev/null 2>&1; then
    sudo chown -R "$USER:$USER" "${existing[@]}"
    echo "‚úÖ Ownership updated"
  else
    echo "‚ö†Ô∏è  sudo not available; cannot chown automatically. You may need:"
    echo "    sudo chown -R $USER:$USER ${existing[*]}"
    return 1
  fi
  echo ""
}

setup_new() {
  echo "==================================="
  echo "  RagAI First-Time Setup"
  echo "==================================="
  echo ""

  echo "üìÅ Creating directory structure..."
  mkdir -p secrets/playwright
  mkdir -p data/{artifacts,conversations,ingest,logs/jobs,candidates,sqlite}
  mkdir -p qdrant_storage
  mkdir -p ollama_models
  echo "‚úÖ Directories created"
  echo ""

  # Install system dependencies (Ubuntu/Debian only)
  if command -v apt-get &> /dev/null; then
    echo "üì¶ Installing system dependencies (requires sudo)..."
    if sudo apt-get update && sudo apt-get install -y curl git python3 python3-pip python3-venv; then
      echo "‚úÖ System dependencies installed"
    else
      echo "‚ö†Ô∏è  Warning: Failed to install some dependencies. You may need to install them manually."
    fi
    echo ""
  else
    echo "‚ÑπÔ∏è  Non-Debian system detected. Please install manually: curl git python3 python3-pip python3-venv"
    echo ""
  fi

  if [ ! -f secrets/admin-tokens ]; then
    echo "üîë Creating admin tokens file..."
    touch secrets/admin-tokens
    chmod 600 secrets/admin-tokens

    if command -v openssl &> /dev/null; then
      SAMPLE_TOKEN=$(openssl rand -hex 32)
      echo "$SAMPLE_TOKEN" > secrets/admin-tokens
      echo "‚úÖ Admin token generated and saved to secrets/admin-tokens"
      echo ""
      echo "üîê Your admin token is:"
      echo "   $SAMPLE_TOKEN"
      echo ""
    else
      echo "‚ö†Ô∏è  openssl not found. Please manually add an admin token to secrets/admin-tokens"
    fi
    echo ""
  else
    echo "‚ÑπÔ∏è  Admin tokens file already exists, skipping token generation"
    echo ""
  fi

  echo "üî® Building Docker images..."
  docker compose build
  echo "‚úÖ Docker images built successfully"
  echo ""

  echo "üöÄ Starting services..."
  # shellcheck disable=SC2207
  local svcs=($(default_services))
  docker compose up -d "${svcs[@]}"
  docker compose ps
  echo ""

  echo "‚ÑπÔ∏è  If you hit permission issues with bind mounts, run:"
  echo "    ./tools/ragaictl change-owner"
  echo ""

  echo "‚è≥ Waiting for Ollama to start..."
  local max_attempts=30
  local attempt=1
  while [ $attempt -le $max_attempts ]; do
    if curl -s -f -m 2 http://localhost:11434/api/version > /dev/null 2>&1; then
      echo "‚úÖ Ollama is ready"
      break
    fi
    sleep 2
    attempt=$((attempt + 1))
  done
  if [ $attempt -gt $max_attempts ]; then
    echo "‚ùå Ollama failed to start"
    echo "   Check logs: ./tools/ragaictl logs ollama"
    exit 1
  fi
  echo ""

  echo "üì• Pulling Ollama models..."
  echo "   Pulling embedding model: nomic-embed-text:latest"
  docker compose exec -T ollama ollama pull nomic-embed-text:latest || true
  echo "   Pulling LLM model: llama3.2:latest"
  docker compose exec -T ollama ollama pull llama3.2:latest || true
  echo ""

  echo "üìã Installed models:"
  docker compose exec -T ollama ollama list || true
  echo ""

  echo "üè• Running health checks..."
  check_health || {
    echo "‚ö†Ô∏è  Setup completed but health checks failed."
    echo "   Check logs: ./tools/ragaictl logs"
    exit 1
  }

  echo "‚úÖ Setup complete!"
  echo "Frontend: http://localhost:5000"
  echo "Admin:    http://localhost:5000/settings.html"
}

start_cmd() {
  if [[ $# -gt 0 ]]; then
    docker compose up -d "$@"
  else
    # shellcheck disable=SC2207
    local svcs=($(default_services))
    docker compose up -d "${svcs[@]}"
  fi
  docker compose ps
  echo ""
  check_health
}

stop_cmd() {
  if [[ $# -gt 0 ]]; then
    docker compose stop "$@"
  else
    docker compose stop
  fi
  docker compose ps
}

down_cmd() {
  docker compose down --remove-orphans
}

build_cmd() {
  local no_cache="false"
  if [[ "${1:-}" == "--no-cache" ]]; then
    no_cache="true"
    shift
  fi

  if [[ "$no_cache" == "true" ]]; then
    if [[ $# -gt 0 ]]; then
      docker compose build --no-cache "$@"
    else
      docker compose build --no-cache
    fi
  else
    if [[ $# -gt 0 ]]; then
      docker compose build "$@"
    else
      docker compose build
    fi
  fi
}

restart_cmd() {
  if [[ $# -gt 0 ]]; then
    docker compose restart "$@"
  else
    # Restart defaults rather than "all" to avoid running one-shot ingestor unexpectedly.
    # shellcheck disable=SC2207
    local svcs=($(default_services))
    docker compose restart "${svcs[@]}"
  fi
  docker compose ps
  echo ""
  check_health
}

case "$command" in
  setup-new)
    setup_new
    ;;
  start)
    start_cmd "$@"
    ;;
  stop)
    stop_cmd "$@"
    ;;
  down)
    down_cmd
    ;;
  status)
    docker compose ps
    ;;
  logs)
    logs_cmd "$@"
    ;;
  build)
    build_cmd "$@"
    ;;
  restart)
    restart_cmd "$@"
    ;;
  export)
    ./tools/export_code.sh "$@"
    ;;
  change-owner)
    change_owner_cmd "$@"
    ;;
  -h|--help|"")
    usage
    ;;
  *)
    usage
    exit 1
    ;;
esac

