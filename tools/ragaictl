#!/usr/bin/env bash
set -euo pipefail

command=${1:-}
shift || true

usage() {
  cat <<'EOF'
Usage: ragaictl <command> [options]

Commands:
  setup-new                             First-time setup (dirs, deps, build, start, pull models)
  start [service...]                    Start services (default: ollama qdrant api frontend), then health check
  stop [service...]                     Stop services (default: all) WITHOUT removing containers
  down                                  Remove containers/networks created by compose (docker compose down)
  status                                Show service status
  logs [service] [--tail N]             Follow logs (optionally scoped to a service)
  build [--no-cache] [service...]       Build images (default: all services)
  restart [service...]                  Restart services (default: all), then health check
  export_code [scope] [--max-lines N]   Export project snapshot (replaces dump_project)

Export scopes:
  all-code   (default, no data, no secrets)
  all        (includes data, excludes secrets)
  api
  ingestor
  frontend

Notes:
  - Secrets are always excluded from exports.
  - 'stop' keeps containers; 'down' removes them.
EOF
}

# Parse simple optional flag for logs
logs_cmd() {
  local service=""
  local tail_arg=""

  if [[ $# -gt 0 && "${1:-}" != --* ]]; then
    service="$1"
    shift
  fi

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --tail)
        tail_arg="--tail=${2:-200}"
        shift 2
        ;;
      *)
        echo "Unknown option for logs: $1"
        exit 1
        ;;
    esac
  done

  if [[ -n "$service" ]]; then
    docker compose logs -f $tail_arg "$service"
  else
    docker compose logs -f $tail_arg
  fi
}

check_health() {
  local max_attempts=30
  local attempt=1
  local api_url="http://localhost:8000/api/health"

  echo "‚è≥ Waiting for API to become available..."
  while [ $attempt -le $max_attempts ]; do
    if curl -s -f -m 2 "$api_url" > /dev/null 2>&1; then
      echo "‚úÖ API is responding"
      break
    fi
    sleep 1
    attempt=$((attempt + 1))
  done

  if [ $attempt -gt $max_attempts ]; then
    echo "‚ùå API failed to start after ${max_attempts}s"
    echo ""
    echo "Recent API logs:"
    docker compose logs api --tail=50
    return 1
  fi

  local health_json
  health_json=$(curl -s -f -m 2 "$api_url" 2>/dev/null || echo '{}')

  local api_status
  local ollama_status
  local qdrant_status
  api_status=$(echo "$health_json" | grep -o '"api":"[^"]*"' | cut -d'"' -f4 || true)
  ollama_status=$(echo "$health_json" | grep -o '"ollama":"[^"]*"' | cut -d'"' -f4 || true)
  qdrant_status=$(echo "$health_json" | grep -o '"qdrant":"[^"]*"' | cut -d'"' -f4 || true)

  echo ""
  echo "=== Health Check Summary ==="
  [[ "$api_status" == "ok" ]] && echo "‚úÖ API OK" || echo "‚ùå API FAILED"
  [[ "$ollama_status" == "ok" ]] && echo "‚úÖ Ollama OK" || echo "‚ùå Ollama FAILED (status: ${ollama_status:-unknown})"
  [[ "$qdrant_status" == "ok" ]] && echo "‚úÖ Qdrant OK" || echo "‚ùå Qdrant FAILED (status: ${qdrant_status:-unknown})"
  echo "==========================="
  echo ""

  [[ "$api_status" == "ok" ]]
}

fix_ownership() {
  # Only chown bind-mounted directories that commonly get root-owned files.
  # Avoid blanket chown of the whole repo.
  local targets=(data config qdrant_storage ollama_models)

  # Only run if those directories exist
  local existing=()
  for t in "${targets[@]}"; do
    [[ -e "$t" ]] && existing+=("$t")
  done

  if [[ ${#existing[@]} -eq 0 ]]; then
    return 0
  fi

  echo "üßπ Fixing ownership on: ${existing[*]}"
  if command -v sudo >/dev/null 2>&1; then
    sudo chown -R "$USER:$USER" "${existing[@]}" || true
  else
    echo "‚ö†Ô∏è  sudo not available; skipping chown. You may need:"
    echo "    sudo chown -R $USER:$USER ${existing[*]}"
  fi
  echo ""
}

setup_new() {
  echo "==================================="
  echo "  RagAI First-Time Setup"
  echo "==================================="
  echo ""

  echo "üìÅ Creating directory structure..."
  mkdir -p secrets/playwright
  mkdir -p data/{artifacts,conversations,ingest,logs/jobs,candidates,sqlite}
  mkdir -p qdrant_storage
  mkdir -p ollama_models
  echo "‚úÖ Directories created"
  echo ""

  # Install system dependencies (Ubuntu/Debian only)
  if command -v apt-get &> /dev/null; then
    echo "üì¶ Installing system dependencies (requires sudo)..."
    if sudo apt-get update && sudo apt-get install -y curl git python3 python3-pip python3-venv; then
      echo "‚úÖ System dependencies installed"
    else
      echo "‚ö†Ô∏è  Warning: Failed to install some dependencies. You may need to install them manually."
    fi
    echo ""
  else
    echo "‚ÑπÔ∏è  Non-Debian system detected. Please install manually: curl git python3 python3-pip python3-venv"
    echo ""
  fi

  if [ ! -f secrets/admin-tokens ]; then
    echo "üîë Creating admin tokens file..."
    touch secrets/admin-tokens
    chmod 600 secrets/admin-tokens

    if command -v openssl &> /dev/null; then
      SAMPLE_TOKEN=$(openssl rand -hex 32)
      echo "$SAMPLE_TOKEN" > secrets/admin-tokens
      echo "‚úÖ Admin token generated and saved to secrets/admin-tokens"
      echo ""
      echo "üîê Your admin token is:"
      echo "   $SAMPLE_TOKEN"
      echo ""
    else
      echo "‚ö†Ô∏è  openssl not found. Please manually add an admin token to secrets/admin-tokens"
    fi
    echo ""
  else
    echo "‚ÑπÔ∏è  Admin tokens file already exists, skipping token generation"
    echo ""
  fi

  echo "üî® Building Docker images..."
  docker compose build
  echo "‚úÖ Docker images built successfully"
  echo ""

  echo "üöÄ Starting services..."
  docker compose up -d ollama qdrant api frontend
  docker compose ps
  echo ""

  fix_ownership

  echo "‚è≥ Waiting for Ollama to start..."
  local max_attempts=30
  local attempt=1
  while [ $attempt -le $max_attempts ]; do
    if curl -s -f -m 2 http://localhost:11434/api/version > /dev/null 2>&1; then
      echo "‚úÖ Ollama is ready"
      break
    fi
    sleep 2
    attempt=$((attempt + 1))
  done
  if [ $attempt -gt $max_attempts ]; then
    echo "‚ùå Ollama failed to start"
    echo "   Check logs: ./tools/ragaictl logs ollama"
    exit 1
  fi
  echo ""

  echo "üì• Pulling Ollama models..."
  echo "   Pulling embedding model: nomic-embed-text:latest"
  docker compose exec -T ollama ollama pull nomic-embed-text:latest || true
  echo "   Pulling LLM model: llama3.2:latest"
  docker compose exec -T ollama ollama pull llama3.2:latest || true
  echo ""

  echo "üìã Installed models:"
  docker compose exec -T ollama ollama list || true
  echo ""

  echo "üè• Running health checks..."
  check_health || {
    echo "‚ö†Ô∏è  Setup completed but health checks failed."
    echo "   Check logs: ./tools/ragaictl logs"
    exit 1
  }

  echo "‚úÖ Setup complete!"
  echo "Frontend: http://localhost:5000"
  echo "Admin:    http://localhost:5000/settings.html"
}

start_cmd() {
  if [[ $# -gt 0 ]]; then
    docker compose up -d "$@"
  else
    docker compose up -d ollama qdrant api frontend
  fi
  docker compose ps
  echo ""
  fix_ownership
  check_health
}

stop_cmd() {
  if [[ $# -gt 0 ]]; then
    docker compose stop "$@"
  else
    docker compose stop
  fi
  docker compose ps
}

down_cmd() {
  docker compose down --remove-orphans
}

build_cmd() {
  local no_cache="false"
  if [[ "${1:-}" == "--no-cache" ]]; then
    no_cache="true"
    shift
  fi

  if [[ "$no_cache" == "true" ]]; then
    if [[ $# -gt 0 ]]; then
      docker compose build --no-cache "$@"
    else
      docker compose build --no-cache
    fi
  else
    if [[ $# -gt 0 ]]; then
      docker compose build "$@"
    else
      docker compose build
    fi
  fi
}

restart_cmd() {
  if [[ $# -gt 0 ]]; then
    docker compose restart "$@"
  else
    docker compose restart
  fi
  docker compose ps
  echo ""
  fix_ownership
  check_health
}

case "$command" in
  setup-new)
    setup_new
    ;;
  start)
    start_cmd "$@"
    ;;
  stop)
    stop_cmd "$@"
    ;;
  down)
    down_cmd
    ;;
  status)
    docker compose ps
    ;;
  logs)
    logs_cmd "$@"
    ;;
  build)
    build_cmd "$@"
    ;;
  restart)
    restart_cmd "$@"
    ;;
  export_code)
    ./tools/export_code.sh "$@"
    ;;
  -h|--help|"")
    usage
    ;;
  *)
    usage
    exit 1
    ;;
esac

