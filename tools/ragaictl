#!/usr/bin/env bash
set -euo pipefail

command=${1:-}
shift || true

usage() {
  cat <<'EOF'
Usage: ragaictl <command> [options]

Commands:
  setup-new                             Complete first-time setup (creates dirs, installs deps, pulls models)
  start                                 Start ollama/qdrant/api/frontend and show status
  stop                                  Stop all services (docker compose down)
  status                                Show service status
  logs [service]                        Follow logs (optionally scoped to a service)
  build                                 Build images (docker compose build)
  rebuild [--no-cache]                  Clean rebuild images (optional no-cache)
  restart [service]                     Restart services
  dump_project [--scope <scope>] [--max-lines <n>]
                                        Dump project code/data snapshot

Dump scopes:
  all-code   (default, no data, no secrets)
  all        (includes data, excludes secrets)
  api
  crawler
  ingestor
  frontend

Notes:
  - Data is only included when an explicit scope requests it (e.g., all).
  - Secrets are always excluded.
EOF
}

check_health() {
  local max_attempts=30
  local attempt=1
  local api_url="http://localhost:8000/api/health"

  echo "‚è≥ Waiting for API to become available..."

  while [ $attempt -le $max_attempts ]; do
    if curl -s -f -m 2 "$api_url" > /dev/null 2>&1; then
      echo "‚úÖ API is responding"
      break
    fi
    sleep 1
    attempt=$((attempt + 1))
  done

  if [ $attempt -gt $max_attempts ]; then
    echo "‚ùå API failed to start after ${max_attempts}s"
    echo ""
    echo "Recent API logs:"
    docker compose logs api --tail=50
    return 1
  fi

  # Get health status from API
  local health_json
  health_json=$(curl -s -f -m 2 "$api_url" 2>/dev/null || echo '{}')

  local api_status=$(echo "$health_json" | grep -o '"api":"[^"]*"' | cut -d'"' -f4)
  local ollama_status=$(echo "$health_json" | grep -o '"ollama":"[^"]*"' | cut -d'"' -f4)
  local qdrant_status=$(echo "$health_json" | grep -o '"qdrant":"[^"]*"' | cut -d'"' -f4)

  echo ""
  echo "=== Health Check Summary ==="

  if [ "$api_status" = "ok" ]; then
    echo "‚úÖ API OK"
  else
    echo "‚ùå API FAILED"
  fi

  if [ "$ollama_status" = "ok" ]; then
    echo "‚úÖ Ollama OK"
  else
    echo "‚ùå Ollama FAILED (status: ${ollama_status:-unknown})"
  fi

  if [ "$qdrant_status" = "ok" ]; then
    echo "‚úÖ Qdrant OK"
  else
    echo "‚ùå Qdrant FAILED (status: ${qdrant_status:-unknown})"
  fi

  echo "==========================="
  echo ""

  # Return success if at least API is OK
  if [ "$api_status" = "ok" ]; then
    return 0
  else
    return 1
  fi
}

setup_new() {
  echo "==================================="
  echo "  RagAI First-Time Setup"
  echo "==================================="
  echo ""

  # Create directory structure
  echo "üìÅ Creating directory structure..."
  mkdir -p secrets/playwright
  mkdir -p data/{artifacts,conversations,ingest,logs/jobs,candidates,sqlite}
  echo "‚úÖ Directories created"
  echo ""

  # Install system dependencies (Ubuntu/Debian only)
  if command -v apt-get &> /dev/null; then
    echo "üì¶ Installing system dependencies (requires sudo)..."
    if sudo apt-get update && sudo apt-get install -y curl git python3 python3-pip python3-venv; then
      echo "‚úÖ System dependencies installed"
    else
      echo "‚ö†Ô∏è  Warning: Failed to install some dependencies. You may need to install them manually."
    fi
    echo ""
  else
    echo "‚ÑπÔ∏è  Non-Debian system detected. Please install these packages manually:"
    echo "   - curl, git, python3, python3-pip, python3-venv"
    echo ""
  fi

  # Create empty admin tokens file if it doesn't exist
  if [ ! -f secrets/admin-tokens ]; then
    echo "üîë Creating admin tokens file..."
    touch secrets/admin-tokens
    chmod 600 secrets/admin-tokens

    # Generate a sample token
    if command -v openssl &> /dev/null; then
      SAMPLE_TOKEN=$(openssl rand -hex 32)
      echo "$SAMPLE_TOKEN" > secrets/admin-tokens
      echo "‚úÖ Admin token generated and saved to secrets/admin-tokens"
      echo ""
      echo "üîê Your admin token is:"
      echo "   $SAMPLE_TOKEN"
      echo ""
      echo "   Save this token! You'll need it to access the admin interface."
      echo "   Location: secrets/admin-tokens"
    else
      echo "‚ö†Ô∏è  openssl not found. Please manually add an admin token to secrets/admin-tokens"
    fi
    echo ""
  else
    echo "‚ÑπÔ∏è  Admin tokens file already exists, skipping token generation"
    echo ""
  fi

  # Build Docker images
  echo "üî® Building Docker images..."
  if docker compose build; then
    echo "‚úÖ Docker images built successfully"
  else
    echo "‚ùå Failed to build Docker images"
    exit 1
  fi
  echo ""

  # Start services
  echo "üöÄ Starting services..."
  docker compose up -d ollama qdrant api frontend
  echo ""

  # Wait for Ollama to be ready
  echo "‚è≥ Waiting for Ollama to start..."
  local max_attempts=30
  local attempt=1
  while [ $attempt -le $max_attempts ]; do
    if curl -s -f -m 2 http://localhost:11434/api/version > /dev/null 2>&1; then
      echo "‚úÖ Ollama is ready"
      break
    fi
    sleep 2
    attempt=$((attempt + 1))
  done

  if [ $attempt -gt $max_attempts ]; then
    echo "‚ùå Ollama failed to start after ${max_attempts} attempts"
    echo "   Check logs: ./tools/ragaictl logs ollama"
    exit 1
  fi
  echo ""

  # Pull Ollama models
  echo "üì• Pulling Ollama models (this may take several minutes)..."
  echo ""

  echo "   Pulling embedding model: nomic-embed-text:latest"
  if docker compose exec -T ollama ollama pull nomic-embed-text:latest; then
    echo "   ‚úÖ nomic-embed-text:latest pulled successfully"
  else
    echo "   ‚ùå Failed to pull nomic-embed-text:latest"
  fi
  echo ""

  echo "   Pulling LLM model: llama3.2:latest"
  if docker compose exec -T ollama ollama pull llama3.2:latest; then
    echo "   ‚úÖ llama3.2:latest pulled successfully"
  else
    echo "   ‚ùå Failed to pull llama3.2:latest"
  fi
  echo ""

  # Verify models
  echo "üìã Installed models:"
  docker compose exec -T ollama ollama list
  echo ""

  # Health check
  echo "üè• Running health checks..."
  check_health || {
    echo ""
    echo "‚ö†Ô∏è  Setup completed but health checks failed."
    echo "   Check logs: ./tools/ragaictl logs"
    exit 1
  }

  echo ""
  echo "==================================="
  echo "  ‚úÖ Setup Complete!"
  echo "==================================="
  echo ""
  echo "Next steps:"
  echo ""
  echo "1. Edit config/allow_block.yml to add your seed URLs and allowed domains"
  echo "2. Access the frontend: http://localhost:5000"
  echo "3. Access the admin console: http://localhost:5000/settings.html (use the admin token shown above)"
  echo "4. Start your first crawl from the admin console"
  echo ""
  echo "For more information, see:"
  echo "  - docs/INSTALL.md"
  echo "  - docs/USER_GUIDE.md"
  echo "  - docs/ADMIN_GUIDE.md"
  echo ""
}

case "$command" in
  setup-new)
    setup_new
    ;;
  start)
    docker compose up -d ollama qdrant api frontend
    docker compose ps
    echo ""
    check_health || exit 1
    ;;
  stop)
    docker compose down
    ;;
  status)
    docker compose ps
    ;;
  logs)
    docker compose logs -f "$@"
    ;;
  build)
    docker compose build
    ;;
  rebuild)
    if [[ "${1:-}" == "--no-cache" ]]; then
      docker compose down --remove-orphans
      docker compose build --no-cache
      docker image prune -f
    else
      docker compose build
    fi
    ;;
  restart)
    docker compose restart "$@"
    ;;
  dump_project)
    ./tools/dump_project.sh "$@"
    ;;
  -h|--help|"")
    usage
    ;;
  *)
    usage
    exit 1
    ;;
esac
